# Shared jobs that are generally applicable to everyone
# Assumes a 'base' job defined elsewhere
#- job:
#    name: verify-test-success
#    description: |
#      Run simple commands as test.
#
#      To use this, set the ``test_command`` variable.
#    run: playbooks/verify-test-success/run.yaml
#    nodeset:
#      nodes:
#        - name: ubuntu-xenial-virt
#          label: ubuntu-xenial-virt
#    vars:
#      test_command: "touch sriov_file"
#      dest_dir: "/opt/stack"
#      devstack_dir: "{{ dest_dir }}/devstack"
#      output_dir: "{{ zuul_output_dir }}/logs"
#      sys_info_dir: "{{ output_dir }}/sys_info"
#      pip_info_log: "{{ sys_info_dir }}/pip_log.txt"
#
#- job:
#    name: verify-dyn-test-success
#    description: |
#      Run simple commands as test.
#
#      To use this, set the ``test_command`` variable.
#    run: playbooks/verify-test-success/run.yaml
#    nodeset:
#      nodes:
#        - name: vm-dyn-xenial
#          label: vm-dyn-xenial
#    vars:
#      test_command: "touch sriov_file"
#
#- job:
#    name: goodbyejob
#    run: playbooks/goodbyejob.yaml

- job:
    name: tap-as-a-service-dsvm-intel-sriov
    description: |
      setup devstack and test port mirroring
      on intel nic using tempest.
    required-projects:
      - opendev.org/x/tap-as-a-service
      - opendev.org/devstack
      - opendev.org/ci-sandbox
    pre-run: playbooks/inteltaptest/pre.yaml
    run: playbooks/inteltaptest/run.yaml
    nodeset:
      nodes:
        - name: controller
          label: ubuntu-xenial-metal
    vars:
      test_command: "touch sriov_file"
      dest_dir: "/opt/stack"
      devstack_dir: "{{ dest_dir }}/devstack"
      output_dir: "{{ zuul_output_dir }}/logs"
      sys_info_dir: "{{ output_dir }}/sys_info"
      pip_info_log: "{{ sys_info_dir }}/pip_log.txt"

#- job:
#    name: run-test-command
#    description: |
#      Run simple command as test.
#
#      To use this, set the ``test_command`` variable.
#    run: playbooks/run-test-command/run.yaml
#    vars:
#      test_command: "touch sriov_file"
#
#- job:
#    name: openstack-tox-lower-constraints
#    parent: openstack-tox
#    branches: ^(?!driverfixes/).*$
#    timeout: 2400
#    description: |
#      Run unit tests using the lower constraints.
#
#      Uses tox with the ``lower-constraints`` environment,
#      which should be configured to use Python 3 by default
#      unless the project does not support Python 3.
#    vars:
#      tox_envlist: lower-constraints
#      bindep_profile: test py35 py36

- job:
    name: tap-as-a-service-tempest-plugin
    parent: devstack-tempest
    description: |
      Perform setup common to all tap-as-a-service tempest tests


- job:
    name: base-intel-devstack
    parent: devstack-minimal
    description: |
      Minimal job including devstack pre/post
      Inherit from this job if you need base pre and post
      roles and devstack pre and post roles.
      TODO- ref for above roles
    nodeset:
      # override this node set if needed
      nodes:
        - name: controller
          label: ubuntu-bionic
    required-projects:
      # amend this to include project src as needed
      - opendev.org/openstack/devstack
    roles:
      # amend this to include project roles as needed
      - zuul: zuul/zuul-jobs
      - zuul: openstack/devstack
    pre-run: playbooks/base-intel/pre.yaml
    run: playbooks/base-intel-devstack/run.yaml
    post-run: playbooks/base-intel/post.yaml
    vars:
      ansible_user_dir: /srv/static/ansible_user_logs/
      dest_dir: "/opt/stack"
      devstack_dir: "{{ dest_dir }}/devstack"
      devstack_repo: git://github.com/openstack-dev/devstack.git
      devstack_version: "master"
      # TODO: detect host IP from zuul vars
      host_ip: "{{ ansible_default_ipv4.address }}"
      no_log: false
      os_password: devstack
      outfile: "{{ output_dir }}/{{ testfile }}"
      output_dir: "{{ zuul_output_dir }}/logs"
      pip_info_log: "{{ sys_info_dir }}/pip_log.txt"
      sys_info_dir: "{{ output_dir }}/sys_info"
      userlogfile: "{{ ansible_user_dir }}/user_output_log.txt"
      zuul_log_verbose: true
      zuul_output_dir: /srv/static/logs
      devstack_services:
        # Ignore any default set by devstack. Emit a "disable_all_services".
        base: false
        # Keystone services
        key: true
      devstack_localrc:
        DEST: "{{ dest_dir }}"
        DATA_DIR: "{{ dest_dir }}/data"
        GIT_BASE: "https://git.openstack.org"
        # Logging
        LOGFILE: "{{ output_dir }}/stack.sh.log"
        SCREEN_LOGDIR: "{{ output_dir }}/screen"
        VERBOSE: true
        ENABLE_DEBUG_LOG_LEVEL: true
        ENABLE_VERBOSE_LOG_LEVEL: true
        # the following is the boilerplate from upstream
        USE_PYTHON3: true
        INSTALL_TESTONLY_PACKAGES: true
        # ip addresses
        HOST_IP: "{{ host_ip }}"
        SERVICE_HOST: "{{ host_ip }}"
        VNCSERVER_LISTEN: 0.0.0.0
        VNCSERVER_PROXYCLIENT_ADDRESS: "{{ host_ip }}"
        # passwords
        OS_USERNAME: demo
        OS_PASSWORD: "{{ os_password }}"
        ADMIN_PASSWORD: "{{ os_password }}"
        MYSQL_PASSWORD: "{{ os_password }}"
        DATABASE_PASSWORD: "{{ os_password }}"
        RABBIT_PASSWORD: "{{ os_password }}"
        SERVICE_PASSWORD: "{{ os_password }}"
        SERVICE_TOKEN: "{{ os_password }}"
        # misc
        DEBUG_LIBVIRT_COREDUMPS: true
        NOVA_VNC_ENABLED: true
      tox_envlist: dsvm-functional
      tox_install_siblings: false
      zuul_copy_output:
        # We need to copy directory with logs to have it in job artifacts also,
        # /opt/stack/logs is default logs directory defined in neutron's
        # tox.ini file
        '{{ output_dir }}/dsvm-functional-logs': logs

- job:
    name: base-intel-no-devstack
    parent: base-intel-devstack
    description: |
      minimal job including devstack pre/post
      Inherit from this job if you just need base
      pre and post playbooks.
      Variables including paths and passwords should
      be mirrored with base-intel-devstack
    run: playbooks/base-intel-no-devstack/run.yaml
    vars:
      testfile: testfile1.txt

- job:
    name: test-baremetal
    parent: base-intel-no-devstack
    description: |
      minimal job including devstack pre/post
    run: playbooks/base-intel-no-devstack/run.yaml
    required-projects:
      - opendev.org/x/tap-as-a-service
      - opendev.org/devstack
      - opendev.org/ci-sandbox
      - opendev.org/openstack/neutron
    vars:
      testfile: testfile1.txt
    nodeset:
      nodes:
        - name: controller
          label: ubuntu-xenial-metal
